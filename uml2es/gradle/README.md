# UML to ES Demo

This gradle project shows the transformation of UML models to entity services models. 

# Setup

To use, create in this folder a file called gradle-local.properties:

mlAppName=xmi2es (or some other suitable name)
mlHost=localhost (set the host)
mlUsername=admin (set the user name)
mlPassword=admin (set the password)
mlRestPort=12929 (choose a suitable port)
mlAppServicesPort=12929 (same as mlRestPort)
mlAppServicesHost=localhost (same as mlHost)
mlTestRestPort=12928 (not used)

To setup your environment, do an initial deploy:

gradle -PenvironmentName=local mlDeploy

# Step 1 - Convert XMI to ES

The first step is to transform UML to ES model descriptors. The UML models are exported as XMI documents. These documents are in data/xmi. We have the following XMIs:

- IMDBMovie.xml - A logical movie model designed in MagicDraw. Explanatory purposes only. 
- IMDBMoviePhysical.xml - A physical movie model designed in MagicDraw. We will make extensive use of this model. 
- RunningRace.xml - Based on the race example from MLU training, designed in MagicDraw. Explanatory purposes only.
- RunningRaceEMF.xml - Similar to the previous but designed using Eclipse Modeling Framework. Explanatory purposes only.
- RunningRaceMono.xml - The race example with some missing detail. It does not have sufficient detail to transform to a valid ES model. It is designed in MagicDraw but does not make use of ES-specific stereotypes, hence the name "mono". Explanatory purposes only. 
- WarnModel.xml - A model, designed in MagicDraw, with several validation issues. Explanatory purposes only. 

To run the transformation:

gradle -PenvironmentName=local buildESModelDescriptors

(If you run this more than once, it might fail the second time, complaining of invalid indexes. To fix this, remove non-string element range indexes from the database and run again.)

The buildESModelDescriptors has two effects:
1. It creates 18 documents in the database, or three for each of the six XMI models. The three documents for each model are: 
- The XMI document itself (e.g., /xmies/xmi/IMDBMoviePhysical.xml)
- The ES model descriptor that we derive from the XMI document (e.g., /xmies/es/IMDBMoviePhysical.xml)
- Our findings (errors, warnings, hints) when attempting to transform XMI to ES (e.g., /xmi2es/findings/IMDBMoviePhysical.xml). To check if we were able to build a valid ES model from XMI, check the validationStatus attribute at the root of each findings document.
2. It copies to the data/entity-services folder the ES model descriptor for IMDBMoviePhysical. This is the model we use in the demo.

# Step 2 - Deploy the Model Descriptors
The next step is to deploy the ES model descriptors as ES models:

gradle -PenvironmentName=local mlgen mlDeploy

This creates the entity services model as a new document in the content database:
- /marklogic.com/entity-services/models/IMDBMoviePhysical.xml

It also creates the corresponding TDE template in the schemas database:
- /MovieModelPhysical-0.0.1.tdex 

It also writes the converter module and query options artifacts to the modules database.
- /ext/entity-services/MovieModelPhysical-0.0.1.xqy
- /Default/xmi2es_proud/rest-api/options/MovieModelPhysical.xml

It also creates element range indexes in the content database. In Admin console, review these. 

The source code for all these artifacts is in the code tree in src/main:
- src/main/ml-config/databases/content-database.json - Range indexes generated by mlgen based on indexes specified in ES model
- src/main/ml-modules/MovieModelPhysical.xml - Search options generated by mlgen based on the ES model
- src/main/ml-modules/ext/entity-services/MovieModelPhysical-0.0.1.xqy - Instance coverter code generated by mlgen based on the ES model. We have modified this code quite a bit, so mlgen keeps our modified code and writes the generated version to MovieModelPhysical-0.0.1-GENERATED.xqy
- src/main/ml-schemas/MovieModelPhysical-0.0.1.tdex - TDE template generate by mlgen. We have modified this quite a bit also, so mlgen keeps our modified code and writes the generated version to MovieModelPhysical-0.0.1-GENERATED.tdex

# Step 2a - Remove Unwanted TDE
Having the TDE template from src/main/ml-schemas/MovieModelPhysical-0.0.1-GENERATED.tdex deployed will cause problems for us later. Delete it from the schemas DB as follows:

- In the code tree, delete src/main/ml-schemas/MovieModelPhysical-0.0.1-GENERATED.tdex
- Run the following:

gradle -PenvironmentName=local mlReloadSchemas

# Step 3 - Ingest movie data
I mocked up some movie data, but you can obtain actual movie data from IMDB.com. To ingest my mocked-up data:

gradle -PenvironmentName=local ingestMovie

This adds 25 new documents to the content database. O 
- 2 bios (e.g., /xmi2es/imdb/bio/bios1.xml)
- 2 movie docs (e.g., xmi2es/imdb/movieDoc/movieDocs1.xml)
- 1 company (/xmi2es/imdb/company/companies1.xml)
- 3 persons (e.g., /xmi2es/imdb/person/persons1.xml)
- 5 movies (e.g., /xmi2es/imdb/movie/movies2.xml)
- 12 roles (e.g., /xmi2es/imdb/role/roles1.xml)

Open them up in query console and review their contents. Also try running the SQL queries; in query console import workspace XMI2ES.xml. 
